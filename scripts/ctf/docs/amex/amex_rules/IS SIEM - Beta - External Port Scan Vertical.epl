module Module_recon_ext_vertical_01;
@RSAAlert(identifiers={"ip_src"})

SELECT window(*) FROM
	Event (
                (medium <> 32 OR device_type IN ('ciscoasa', 'ciscopix')) AND
		ip_src IS NOT NULL AND
		ip_dst IS NOT NULL AND
                ip_src NOT IN ('127.0.0.1', '224.0.0.252', '0.0.0.0') AND
                (net_src NOT IN ('amex_internal_src', 'amex_public_src') OR net_src IS NULL) AND
                ip_dst NOT IN ('12.10.219.220', '12.10.219.221', '12.10.219.222', '12.10.219.223', '12.10.219.224', '12.10.219.225', '12.10.219.226', '12.10.219.227', '12.10.219.228', '12.10.219.229', '148.173.97.161', '148.173.97.162', '148.173.97.163', '148.173.97.164', '148.173.97.165', '148.173.97.166', '148.173.97.167', '148.173.97.168', '148.173.97.169', '148.173.97.170', '12.10.219.37', '148.173.97.149', '12.10.219.98', '12.10.219.176', '193.32.34.67', '148.173.89.130', '203.170.25.14', '203.170.25.21', '203.170.25.10', '12.105.183.201', '12.105.183.200', '148.173.89.129')
	).std:groupwin(ip_src, ip_dst)
		.std:unique(ip_dstport, tcp_dstport, udp_dstport)
		.win:time_length_batch(60 sec, 60)
		GROUP BY ip_src, ip_dst
		HAVING count(*) = 60
                OUTPUT first every 30 minutes;

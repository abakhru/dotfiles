rsa:

  records:
    sources:
     nw: nw://admin:netwitness@10.101.217.47:50005?compression=0
    streams:
     Event: Event?timeOrdered=false&linkedSources=nw

  security:
    pki:
      verify-certificates: false

  transport:
    bus:
      virtualHost: "/rsa/system"
      enabled: true
      shutdown-timeout: 5ms
    client:
      protocol: http
    http:
      enabled: true

  analytics:
    auto-start: true

    manager:

      topology-configs:
       -
        name: uba
        enabled: true
        num-threads: 5
        root-flow: winauth
        max-worker-queue-size: 409600000
        subflow-max-size: 10
        stream-id: Event

      flow-configs:
      -
        name: winauth
        event-type: Event
        enabled: true
        time-source: enrichment.rsa.analytics.uba.winauth.normalized.timestamp
        activities:
         - normalized
         # - lookupclassifier
         - highservers
         - failedservers
         - newserver
         - newdevice
         - newdeviceservice
         - highserverscore
         - failedserversscore
         - newserverscore
         - newdevicescore
         - pthscore
         - aggregation
         - alert

      activity-configs:
      -
        name: normalized
        shard-key: user_dst
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        properties:
          transforms:
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.TimeConvert
              outputType: java.lang.Long
              conversion: SecondsSinceEpoch
              srcKey: event_time
              dstKey: timestamp
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.ConditionalFieldCopy
              outputType: java.lang.String
              srcKey: alias_host
              condition: "#event['reference_id'] == '4776'"
              dstKey: hostname
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.ConditionalFieldCopy
              outputType: java.lang.String
              srcKey: host_src
              condition: "#event['reference_id'] == '4624' or #event['reference_id'] == '4625'"
              dstKey: hostname
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.ConditionalFieldCopy
              outputType: java.lang.String
              srcKey: service_name
              condition: "#event['reference_id'] == '4768' or #event['reference_id'] == '4769' or #event['reference_id'] == '4770'"
              dstKey: hostname
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.RemovePattern
              outputType: java.lang.String
              returnAsArray: false
              regex: "[\\.$].*|.*[/\\\\]| |(&nbsp;)"
              srcKey: enrichment.rsa.analytics.uba.winauth.normalized.hostname
              dstKey: regexoutput
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.ChangeCase
              outputType: java.lang.String
              srcKey: enrichment.rsa.analytics.uba.winauth.normalized.regexoutput
              dstKey: hostname
              to-lower: false
      -
        name: highservers
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.SlidingWindowCardinalityScore
        shard-key: user_dst
        enabled: true
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0"
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba.winauth.normalized.hostname
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: failedservers
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.SlidingWindowCardinalityScore
        shard-key: user_dst
        enabled: true
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0 and #event['event_type'] == 'Failure Audit'"
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba.winauth.normalized.hostname
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: newdevice
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.NewElementScore
        shard-key: user_dst
        enabled: true
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 1"
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba.winauth.normalized.hostname
          analysis-window: 604800000
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: newserver
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.NewElementScore
        shard-key: user_dst
        enabled: true
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0"
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba.winauth.normalized.hostname
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: newdeviceservice
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.NewDeviceServiceScore
        shard-key: user_dst
        enabled: true
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba.winauth.normalized.hostname
          is-device-key: enrichment.rsa.analytics.uba.winauth.lookupclassifier.isDevice
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: highserverscore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0"
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Ratio
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.highservers.cardinality|enrichment.rsa.analytics.uba.winauth.highservers.average_cardinality
            dstKey: ratio
            returnAsArray: false
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.highserverscore.ratio
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: failedserversscore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0"
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Ratio
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.failedservers.cardinality|enrichment.rsa.analytics.uba.winauth.failedservers.average_cardinality
            dstKey: ratio
            returnAsArray: false
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.failedserversscore.ratio
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: newdevicescore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 1"
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Ratio
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.newdevice.cardinality|enrichment.rsa.analytics.uba.winauth.newdevice.average_cardinality
            dstKey: ratio
            returnAsArray: false
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.newdevicescore.ratio
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: pthscore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.newdeviceservice.score
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: newserverscore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        # precondition: "#event[enrichment]['rsa.analytics.uba.winauth.lookupclassifier'][isDevice] == 0"
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Ratio
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.newserver.cardinality|enrichment.rsa.analytics.uba.winauth.newserver.average_cardinality
            dstKey: ratio
            returnAsArray: false
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba.winauth.newserverscore.ratio
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: alert
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.AlertRuleEvaluation
        properties:
          version: 11.0.FIXME
          vendor: RSA
          product: Event Stream Analysis
          moduleId: Suspected UBA
          eventIdFieldName: event_source_id
          moduleSeverity: 8
          # condition: "#event[enrichment]['rsa.analytics.uba.winauth.aggregation'][confidence] > 0"
          alerterProperties:
            queueSize: 0
            virtualHost: "/rsa/system"
            username: "guest"
            password: "guest"
            exchangeName: "carlos.alerts"
            exchangeType: headers
            durable: true
            autoDelete: false
      -
        name: lookupclassifier
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TableLookupEnrichment
        properties:
          shared-table-name: deviceserver
          key: enrichment.rsa.analytics.uba.winauth.normalized.hostname

      -
        name: aggregation
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.AggregationEnrichment
        properties:
          optional-fields:
          -
            score-name: enrichment.rsa.analytics.uba.winauth.highserverscore.score
            weight: 0.2
          -
            score-name: enrichment.rsa.analytics.uba.winauth.failedserversscore.score
            weight : 0.1
          -
            score-name: enrichment.rsa.analytics.uba.winauth.newserverscore.score
            weight: 0.1
          -
            score-name: enrichment.rsa.analytics.uba.winauth.newdevicescore.score
            weight : 0.2
          -
            score-name: enrichment.rsa.analytics.uba.winauth.pthscore.score
            weight : 0.3

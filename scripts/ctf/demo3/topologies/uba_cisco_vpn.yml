rsa:

  records:
    sources:
     nw: nw://admin:netwitness@10.101.217.47:50005?compression=0
    streams:
     Event: Event?timeOrdered=false&linkedSources=nw

  geoip:
    database-directory: /opt/rsa/esa-analytics-server/geoip
    load-organizations: true

  security:
    pki:
      verify-certificates: false

  transport:
    bus:
      virtual-host: "/rsa/system"
      enabled: true
      shutdown-timeout: 5ms
    client:
      protocol: http
    http:
      enabled: true

  analytics:
    auto-start: true
    manager:

      topology-configs:
       -
        name: UbaCisco
        enabled: true
        num-threads: 10
        root-flow: vpn
        max-worker-queue-size: 409600000
        subflow-max-size: 10
        stream-id: Event

      flow-configs:
      -
        name: vpn
        event-type: Event
        enabled: true
        time-source: enrichment.rsa.analytics.uba-cisco.vpn.normalized.timestamp
        filter: "(#event[device_type] != ciscoasa)"
        activities:
         - geoip
         - normalized
         - loginfailures
         - rarehost
         - rareisp
         - rarelocation
         - newisp
         - alert

      activity-configs:
      -
        name: geoip
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.GeoIpEnrichment
        shard-key: ip_src
        enabled: true
        properties:
          include-org: true
      -
        name: normalized
        shard-key: ip_src
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        properties:
          transforms:
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.TimeConvert
              outputType: java.lang.Long
              conversion: "SecondsSinceEpoch"
              srcKey: time
              dstKey: timestamp
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.FieldConcat
              outputType: java.lang.String
              srcKey: enrichment.rsa.analytics.uba-cisco.vpn.geoip.region|enrichment.rsa.analytics.uba-cisco.vpn.geoip.country_code
              dstKey: location
              returnAsArray: false
      -
        name: loginfailures
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.EventCountScore
        shard-key: user_dst
        enabled: true
        precondition: "#event['ec_outcome'] == 'Failure'" # Add failure msgid
        properties:
          session-key: user_dst
          session-config:
            inactivity-timeout: 0 # 30 days
            max-event-count: 0
            max-duration: 0
      -
        name: rarehost
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.SlidingWindowCardinalityScore
        shard-key: user_dst
        enabled: true
        properties:
          session-key: user_dst
          primary-key: alias_host
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: rarelocation
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.SlidingWindowCardinalityScore
        shard-key: user_dst
        enabled: true
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba-cisco.vpn.normalized.location
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: rareisp
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.SlidingWindowCardinalityScore
        shard-key: user_dst
        enabled: true
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba-cisco.vpn.geoip.organization
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: newisp
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.NewElementScore
        shard-key: user_dst
        enabled: true
        properties:
          session-key: user_dst
          primary-key: enrichment.rsa.analytics.uba-cisco.vpn.geoip.organization
          min-event-threshold: 0
          session-config:
            inactivity-timeout: 0
            max-event-count: 0
            max-duration: 0
      -
        name: rarehostscore
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        enabled: true
        shard-key: user_dst
        properties:
          transforms:
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Ratio
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba-cisco.vpn.highservers.cardinality|enrichment.rsa.analytics.uba-cisco.winauth.highservers.average_cardinality
            dstKey: ratio
            returnAsArray: false
          -
            transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.Exponential
            outputType: java.lang.Double
            srcKey: enrichment.rsa.analytics.uba-cisco.winauth.highserverscore.ratio
            dstKey: score
            exponentMultiplier: 1.0
            complement: true
            scalar: 100.0
            range: 100.0
            returnAsArray: false
      -
        name: alert
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.AlertRuleEvaluation
        properties:
          version: 11.0.FIXME
          vendor: RSA
          product: Event Stream Analysis
          moduleId: Suspected UBA VPN
          eventIdFieldName: event_source_id
          moduleSeverity: 8
          alerterProperties:
            queueSize: 0
            virtualHost: "/rsa/system"
            username: "guest"
            password: "guest"
            exchangeName: "carlos.alerts"
            exchangeType: headers
            durable: true
            autoDelete: false

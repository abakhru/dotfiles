rsa:

  records:
    sources:
     nw: nw://admin:netwitness@10.101.217.47:50005?compression=0
    streams:
     Event: Event?timeOrdered=false&linkedSources=nw

  security:
    pki:
      verify-certificates: false

  transport:
    bus:
      virtualHost: "/rsa/system"
      enabled: true
      shutdown-timeout: 5ms
    client:
      protocol: http
    http:
      enabled: true

  analytics:
    auto-start: true
    manager:
      topology-configs:
       -
        name: HttpLog
        enabled: true
        num-threads: 10
        root-flow: c2
        max-worker-queue-size: 409600000
        subflow-max-size: 10
        stream-id: Event

      flow-configs:
      -
        name: c2
        event-type: Event
        enabled: true
        time-source: enrichment.rsa.analytics.http-log.c2.normalized.timestamp
        filter: "(#event[medium] != 32) or (#event[fqdn] == null) or (#event[fqdn] matches '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$')"
        activities:
         - normalized
         # Enable when Context-hub interface is implemented
         #- ctxhub
         #- domain_wl_filter
         - newdomain
         - useragent
         - referer
         - ua
         - beaconing
         - smooth
         - whois
         - command_control
         - alert

      activity-configs:
      -
        name: normalized
        shard-key: fqdn
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.TransformEvent
        properties:
          transforms:
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.FieldCopy
              outputType: java.lang.String
              srcKey: fqdn
              dstKey: full_domain
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.FieldCopy
              outputType: java.lang.String
              srcKey: user_agent
              dstKey: user_agent
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.FoldDomain
              outputType: java.lang.String
              srcKey: fqdn
              dstKey: domain
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.TimeConvert
              outputType: java.lang.Long
              conversion: "SecondsSinceEpoch"
              srcKey: event_time
              dstKey: timestamp
              returnAsArray: false
            -
              transform: com.rsa.asoc.esa.analytics.topology.framework.transform.instance.FieldConcat
              outputType: java.lang.String
              srcKey: ip_src|enrichment.rsa.analytics.http-log.c2.normalized.full_domain
              dstKey: srcip_full_domain
              returnAsArray: false
      -
        # TODO: Configure Cache params
        name: newdomain
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.AgeScore
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
        enabled: true
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
          min-event-threshold: 5
          session-config:
            inactivity-timeout: 7776000000
            max-event-count: 0
            max-duration: 0
      -
        name: useragent
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.CardinalityScore
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.user_agent
        enabled: true
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.user_agent
          primary-key: ip_src
          min-event-threshold: 4
          max-cardinality: 100
          avg-key-life: 604800000
          lambda: 0.05
          is-low-ratio: false
          min-cond-threshold: 1
          is-low-cardinality: true
          beta: 5
          session-config:
            inactivity-timeout: 604800000
            max-event-count: 0
            max-duration: 0
      -
        name: referer
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.CardinalityScore
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
        enabled: true
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] != null and #event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] < 259200000"
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.full_domain
          primary-key: ip_src
          min-event-threshold: 4
          max-cardinality: 100
          avg-key-life: 604800000
          lambda: 0.22
          is-low-ratio: false
          min-cond-threshold: 1
          is-low-cardinality: true
          beta: 2.64
          condition: "#event[referer] == null"
          session-config:
            inactivity-timeout: 604800000
            max-event-count: 0
            max-duration: 0
      -
        name: ua
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.CardinalityScore
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
        enabled: true
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] != null and #event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] < 259200000"
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.full_domain
          primary-key: ip_src
          min-event-threshold: 4
          max-cardinality: 100
          avg-key-life: 604800000
          lambda: 0.2
          is-low-ratio: false
          min-cond-threshold: 1
          is-low-cardinality: true
          beta: 2.64
          condition: "#event[enrichment]['rsa.analytics.http-log.c2.user_agent.cardinality'] == null or #event[enrichment]['rsa.analytics.http-log.c2.user_agent.cardinality'] < 10"
          session-config:
            inactivity-timeout: 604800000
            max-event-count: 0
            max-duration: 0

      -
        name: beaconing
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.PeriodicityScore
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
        enabled: true
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] != null and #event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] < 259200000 and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] != null and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] < 10"
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.srcip_full_domain
          jitter-standard-deviation: 10000
          num-clicks: 14
          session-config:
            inactivity-timeout: 172800000
            max-event-count: 0
            max-duration: 0
      -
        name: smooth
        type: com.rsa.asoc.esa.analytics.topology.analytics.score.Rectifier1Score
        shard-key: enrichment.rsa.analytics.http-log.c2.normalized.domain
        enabled: true
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] != null and #event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] < 259200000 and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] != null and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] < 10"
        properties:
          session-key: enrichment.rsa.analytics.http-log.c2.normalized.full_domain
          primary-key: enrichment.rsa.analytics.http-log.c2.beaconing.score
          mean-life: 604800000
          session-config:
            inactivity-timeout: 604800000
            max-event-count: 0
            max-duration: 0
      -
        name: whois
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.WhoisEnrichment
        enabled: true
        properties:
          lookup-field-names: "enrichment.rsa.analytics.http-log.c2.normalized.domain|domain|enrichment.normalized.domain"
          default-age: 182
          default-validity: 182
          constant-a: 60.8
          constant-b: 280.6
          constant-c: 1269.0

      -
        name: alert
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.AlertRuleEvaluation
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.command_control.aggregate'] != null and #event[enrichment]['rsa.analytics.http-log.c2.command_control.aggregate'] > 70"
        properties:
          version: 11.0.FIXME
          vendor: RSA
          product: Event Stream Analysis
          moduleId: Suspected C&C
          eventIdFieldName: event_source_id
          moduleSeverity: 8
          alerterProperties:
            queueSize: 0
            virtualHost: "/rsa/system"
            username: "guest"
            password: "guest"
            exchangeName: "carlos.alerts"
            exchangeType: headers
            durable: true
            autoDelete: false
      -
        name: command_control
        enabled: true
        type: com.rsa.asoc.esa.analytics.topology.framework.activity.enrichment.AggregationEnrichment
        min-confidence: 20
        precondition: "#event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] != null and #event[enrichment]['rsa.analytics.http-log.c2.newdomain.age'] < 259200000 and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] != null and #event[enrichment]['rsa.analytics.http-log.c2.referer.cardinality'] < 10 and #event[enrichment]['rsa.analytics.http-log.c2.smooth.score'] != null and #event[enrichment]['rsa.analytics.http-log.c2.smooth.score'] > 85"
        properties:
          optional-fields:
          -
            score-name: enrichment.rsa.analytics.http-log.c2.referer.score"
            weight: 0.24
          -
            score-name: enrichment.rsa.analytics.http-log.c2.referer.ratio_score
            weight : 0.22
          -
            score-name: enrichment.rsa.analytics.http-log.c2.ua.ratio_score"
            weight: 0.07
          -
            score-name: enrichment.rsa.analytics.http-log.c2.whois.age_score
            weight : 0.44
          -
            score-name: enrichment.rsa.analytics.http-log.c2.whois.validity_score
            weight : 0.03

    whois:
      whoisUserId: rsaWhoisESAUser
      whoisPassword: netwitness!!!whois
      allowedRequests: 100
      allowedRequestsIntervalSeconds: 60
      waitForHttpRequest: true
      insecureConnection: true
      whoisHttpsProxy: http://emc-proxy1.rsa.lab.emc.com:82
      refreshIntervalSeconds: 1000000
